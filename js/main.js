const translations = {
  en: {
    title_home: "Home | Nima Salamat",
    title_about: "About | Nima Salamat",
    title_contact: "Contact | Nima Salamat",
    nav_home: "ðŸ  Home",
    nav_about: "â„¹ï¸ About",
    nav_contact: "âœ‰ï¸ Contact",
    job_title: "ðŸ’» Computer Engineer",
    welcome: "Welcome to my website!",
    intro_paragraph: "Hi! Iâ€™m Nima Salamat, a computer engineer passionate about web and desktop development. Here are my projects.",
    my_projects: "My Projects",
    loading_projects: "Loading projects...",
    loading_error: "Error loading projects.",
    retry: "Retry",
    about_heading: "About Me ðŸ“–",
    about_casual: "Hello! Iâ€™m Nima. Iâ€™m a computer engineer currently studying at Amol University of Special Modern Technologies...",
    skills_heading: "Skills",
    skill_django: "Django",
    skill_channels: "Django Channels",
    skill_celery: "Celery",
    skill_pyside6: "PySide6 / PyQt",
    skill_opencv: "Python OpenCV",
    skill_rust: "Rust",
    skill_htmlcss: "HTML / CSS",
    skill_js: "JavaScript",
    skill_react: "React",
    skill_sql: "SQL / MySQL",
    skill_redis: "Redis",
    skill_docker: "Docker",
    contact_heading: "Contact Me ðŸ“¬",
    input_name_label: "Your Name",
    input_email_label: "Your Email",
    input_message_label: "Your Message",
    placeholder_name: "Enter your name",
    placeholder_email: "Enter your email",
    placeholder_message: "Type your message here...",
    button_send: "Send ðŸ“¤"
  },

  fa: {
    title_home: "Ø®Ø§Ù†Ù‡ | Nima Salamat",
    title_about: "Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù† | Nima Salamat",
    title_contact: "ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ù† | Nima Salamat",
    nav_home: "ðŸ  Ø®Ø§Ù†Ù‡",
    nav_about: "â„¹ï¸ Ø¯Ø±Ø¨Ø§Ø±Ù‡",
    nav_contact: "âœ‰ï¸ ØªÙ…Ø§Ø³",
    job_title: "ðŸ’» Ù…Ù‡Ù†Ø¯Ø³ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±",
    welcome: "Ø¨Ù‡ ÙˆØ¨â€ŒØ³Ø§ÛŒØª Ù…Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!",
    intro_paragraph: "Ø³Ù„Ø§Ù…! Ù…Ù† Ù†ÛŒÙ…Ø§ Ø³Ù„Ø§Ù…Ø§Øª Ù‡Ø³ØªÙ…...",
    my_projects: "Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†",
    loading_projects: "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§...",
    loading_error: "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§.",
    retry: "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯",
    about_heading: "Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù† ðŸ“–",
    about_casual: "Ø³Ù„Ø§Ù…! Ù…Ù† Ù†ÛŒÙ…Ø§ Ù‡Ø³ØªÙ…ØŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±...",
    skills_heading: "Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§",
    skill_django: "Ø¬Ù†Ú¯Ùˆ",
    skill_channels: "Ø¬Ù†Ú¯Ùˆ Ú†Ù†Ù„Ø²",
    skill_celery: "Ø³Ù„Ø±ÛŒ",
    skill_pyside6: "PySide6 / PyQt",
    skill_opencv: "Ù¾Ø§ÛŒØªÙˆÙ† OpenCV",
    skill_rust: "Ø±Ø§Ø³Øª (Rust)",
    skill_htmlcss: "HTML / CSS",
    skill_js: "Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª",
    skill_react: "Ø±ÛŒâ€ŒØ§Ú©Øª",
    skill_sql: "SQL / MySQL",
    skill_redis: "Ø±Ø¯ÛŒØ³",
    skill_docker: "Ø¯Ø§Ú©Ø±",
    contact_heading: "ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ù† ðŸ“¬",
    input_name_label: "Ù†Ø§Ù… Ø´Ù…Ø§",
    input_email_label: "Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§",
    input_message_label: "Ù¾ÛŒØ§Ù… Ø´Ù…Ø§",
    placeholder_name: "Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
    placeholder_email: "Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
    placeholder_message: "Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...",
    button_send: "Ø§Ø±Ø³Ø§Ù„ ðŸ“¤"
  }
};

// Set default language and theme if not saved
if (!localStorage.getItem('site-language')) {
  localStorage.setItem('site-language', 'en');
}
if (!localStorage.getItem('site-theme')) {
  localStorage.setItem('site-theme', 'dark');
}

const savedLang = localStorage.getItem('site-language');
const currentTheme = localStorage.getItem('site-theme');

// Apply language
function applyTranslations(lang) {
  document.documentElement.lang = lang;

  const titleKey = document.querySelector('title').getAttribute('data-i18n');
  if (translations[lang][titleKey]) {
    document.title = translations[lang][titleKey];
  }

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang][key]) {
      el.innerText = translations[lang][key];
    }
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (translations[lang][key]) {
      el.setAttribute('placeholder', translations[lang][key]);
    }
  });
}

applyTranslations(savedLang);

// Apply theme
if (currentTheme === 'dark') {
  document.body.setAttribute('data-theme', 'dark');
}

// Theme toggle
const themeToggleBtn = document.querySelector('.theme-toggle');
if (themeToggleBtn) {
  themeToggleBtn.addEventListener('click', () => {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.body.removeAttribute('data-theme');
      localStorage.setItem('site-theme', 'light');
    } else {
      document.body.setAttribute('data-theme', 'dark');
      localStorage.setItem('site-theme', 'dark');
    }
  });
}

// Language switch buttons
document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const newLang = btn.getAttribute('data-lang');
    localStorage.setItem('site-language', newLang);
    applyTranslations(newLang);
    if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
      fetchAndRenderProjects();
    }
  });
});

// GitHub projects
async function fetchAndRenderProjects() {
  const container = document.getElementById('projects-container');
  if (!container) return;
  const lang = localStorage.getItem('site-language');
  container.innerHTML = `<p>${translations[lang].loading_projects}</p>`;

  try {
    const reposRes = await fetch('https://api.github.com/users/nima-salamat/repos');
    if (!reposRes.ok) throw new Error('GitHub API error');
    const repos = await reposRes.json();
    const publicRepos = repos.filter(r => !r.name.startsWith('.'));
    const cards = await Promise.all(publicRepos.map(async repo => {
      let description = repo.description || '';
      try {
        const readmeRes = await fetch(`https://api.github.com/repos/nima-salamat/${repo.name}/readme`);
        if (readmeRes.ok) {
          const readmeJson = await readmeRes.json();
          const contentBase64 = readmeJson.content;
          const decoded = atob(contentBase64.replace(/\n/g, ''));
          description = decoded.slice(0, 200).replace(/[#=*`]/g, '').split('\n').slice(0, 3).join(' ');
        }
      } catch (_) {}
      return {
        name: repo.name,
        html_url: repo.html_url,
        desc: description || translations[lang].loading_projects
      };
    }));

    container.innerHTML = '';
    cards.forEach(card => {
      const cardEl = document.createElement('div');
      cardEl.classList.add('project-card');
      cardEl.innerHTML = `
        <h3>${card.name}</h3>
        <p>${card.desc}...</p>
        <a href="${card.html_url}" target="_blank" class="repo-link">GitHub â†—</a>
      `;
      container.appendChild(cardEl);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <p>${translations[savedLang].loading_error}</p>
      <button id="retry-btn">${translations[savedLang].retry}</button>
    `;
    document.getElementById('retry-btn').addEventListener('click', fetchAndRenderProjects);
  }
}

if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
  fetchAndRenderProjects();
}

// Sidebar menu toggle
const menuToggle = document.querySelector('.menu-toggle');
const sidebarEl = document.querySelector('.sidebar');

menuToggle.addEventListener('click', () => {
  const isOpen = sidebarEl.classList.contains('sidebar--open');
  sidebarEl.classList.toggle('sidebar--open', !isOpen);
  document.body.classList.toggle('menu-open', !isOpen);
});

sidebarEl.querySelectorAll('a').forEach(link => {
  link.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
      sidebarEl.classList.remove('sidebar--open');
      document.body.classList.remove('menu-open');
    }
  });
});

window.addEventListener('resize', () => {
  if (window.innerWidth <= 768) {
    sidebarEl.classList.remove('sidebar--open');
    document.body.classList.remove('menu-open');
  }
});

// Hide loader on load
window.addEventListener('load', () => {
  setTimeout(() => {
    const loaderEl = document.getElementById('loader');
    if (loaderEl) loaderEl.style.display = 'none';
  }, 500);
});
